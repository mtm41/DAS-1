!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("did-resolver"),require("tweetnacl"),require("tweetnacl-util"),require("ed2curve-esm")):"function"==typeof define&&define.amd?define(["exports","did-resolver","tweetnacl","tweetnacl-util","ed2curve-esm"],t):t((e=e||self).naclDid={},e.didResolver,e.tweetnacl,e.naclutil,e.ed2curveEsm)}(this,(function(e,t,r,i,n){function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i;var s=async function(e){return r.randomBytes(e)};function a(e){return"string"==typeof e?i.decodeUTF8(e):e}function c(e){return i.encodeBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function d(e){return i.decodeBase64(function(e){switch(e.length%4){case 0:return e;case 2:return e+"==";case 3:return e+"=";default:throw new Error("Invalid base64url encoded string")}}(e).replace(/-/g,"+").replace(/_/g,"/"))}var u=c(i.decodeUTF8(JSON.stringify({typ:"JWT",alg:"Ed25519"})));class y{constructor(e,r){this.did="did:nacl:"+c(e.publicKey),this.privateKey=e.secretKey,this.publicKey=e.publicKey;var i=n.convertKeyPair(e);this.encPublicKey=i.publicKey,this.encPrivateKey=i.secretKey,this.resolver=r||new t.Resolver({nacl:K})}toJSON(){return{did:this.did,privateKey:i.encodeBase64(this.privateKey)}}sign(e){return{data:e,signer:this.did,signature:r.sign.detached(a(e),this.privateKey)}}verify(e){return r.sign.detached.verify(a(e.data),e.signature,this.publicKey)}createJWT(e){var t=Math.floor(Date.now()/1e3),r=u+"."+c(i.decodeUTF8(JSON.stringify(o({},e,{iss:this.did,iat:t}))));return r+"."+c(this.sign(r).signature)}async resolveEncryptionPublicKey(e){try{var t=await this.resolver.resolve(e);if(t){var r=t.publicKey.find(e=>"Curve25519EncryptionPublicKey"===e.type);if(r&&r.publicKeyBase64)return i.decodeBase64(r.publicKeyBase64)}}catch(e){}}async openSession(e,t){if(void 0===t&&(t=!1),e===this.did)return new h(this);var n=await this.resolveEncryptionPublicKey(e);if(!n){if("string"!=typeof t){if(!0===t)return new h(this);throw new Error("Recipient DID "+e+" does not have a valid encryption publicKey")}n=i.decodeBase64(t)}return new l(this.did,e,i.encodeBase64(n),r.box.before(n,this.encPrivateKey))}async encrypt(e,t){if(e===this.did){var n=await s(r.secretbox.nonceLength),o=r.secretbox(a(t),n,this.encPrivateKey);return{to:e,nonce:i.encodeBase64(n),ciphertext:i.encodeBase64(o),version:"xsalsa20-poly1305"}}var c=w(e),d=await s(r.box.nonceLength),u=r.box(a(t),d,c,this.encPrivateKey);return{to:e,from:this.did,toPublicKey:i.encodeBase64(c),nonce:i.encodeBase64(d),ciphertext:i.encodeBase64(u),version:"x25519-xsalsa20-poly1305"}}decrypt(e){var{from:t,to:n,nonce:o,ciphertext:s,version:a}=e;switch(a){case"x25519-xsalsa20-poly1305":if(t!==this.did&&n!==this.did)throw new Error("This was not encrypted to "+this.did);var c=t===this.did?n:t;if(!c)throw new Error("No counter party included");return i.encodeUTF8(r.box.open(i.decodeBase64(s),i.decodeBase64(o),w(c),this.encPrivateKey));case"xsalsa20-poly1305":if(n!==this.did)throw new Error("This was not encrypted to "+this.did);return i.encodeUTF8(r.secretbox.open(i.decodeBase64(s),i.decodeBase64(o),this.encPrivateKey));default:throw new Error("We do not support "+a)}}}class p{constructor(e){this.to=e}}class l extends p{constructor(e,t,r,i){super(t),this.from=e,this.sharedKey=i,this.toPublicKey=r,this.template={toPublicKey:r,from:e,to:t,version:"x25519-xsalsa20-poly1305"}}async encrypt(e){var t=await s(r.box.nonceLength),n=r.box.after(a(e),t,this.sharedKey);return o({},this.template,{nonce:i.encodeBase64(t),ciphertext:i.encodeBase64(n)})}decrypt(e){var{from:t,to:n,nonce:o,ciphertext:s,version:a}=e;if("x25519-xsalsa20-poly1305"!==a)throw new Error("We do not support "+a);if(t!==this.from&&n!==this.to)throw new Error("This was not encrypted to us");return i.encodeUTF8(r.box.open.after(i.decodeBase64(s),i.decodeBase64(o),this.sharedKey))}}class h extends p{constructor(e){super(e.did),this.id=e}async encrypt(e){return this.id.encrypt(this.to,e)}decrypt(e){return this.id.decrypt(e)}}function f(e){var t=v(e.signer);return r.sign.detached.verify(a(e.data),e.signature,t)}function v(e){return d(t.parse(e).id)}function w(e){if(!e.match(/^did:nacl:/))throw new Error("Only nacl dids are supported");return n.convertPublicKey(v(e))}async function K(e,t){var r=d(t.id);return{"@context":"https://w3id.org/did/v1",id:e,publicKey:[{id:e+"#key1",type:"ED25519SignatureVerification",owner:e,publicKeyBase64:i.encodeBase64(r)},{id:e+"#key2",type:"Curve25519EncryptionPublicKey",owner:e,publicKeyBase64:i.encodeBase64(n.convertPublicKey(r))}],authentication:[{type:"ED25519SigningAuthentication",publicKey:e+"#key1"}]}}e.ASYM_CIPHER_VERSION="x25519-xsalsa20-poly1305",e.EncryptedSession=p,e.NaCLIdentity=y,e.SYM_CIPHER_VERSION="xsalsa20-poly1305",e.createIdentity=function(e){return new y(r.sign.keyPair(),e)},e.decodeBase64Url=d,e.didToEncPubKey=w,e.encodeBase64Url=c,e.loadIdentity=function(e,t){var n=new y(r.sign.keyPair.fromSecretKey(i.decodeBase64(e.privateKey)),t);if(n.did!==e.did)throw new Error("Provided PrivateKey does not match the DID");return n},e.normalizeClearData=a,e.resolver=K,e.setRandomBytesSource=function(e){s=e},e.verifyJWT=function(e){var t=e.split(".");if(t[0]!==u)throw new Error("Incorrect JWT Type");var r=JSON.parse(i.encodeUTF8(d(t[1])));if(!r.iss)throw new Error("JWT did not contain an `iss`");if(void 0!==r.exp){if("number"!=typeof r.exp)throw new Error("Invalid exp in JWT "+r.exp+" = "+typeof r.exp);if(1e3*r.exp<(new Date).getTime())throw new Error("JWT expired on: "+r.exp)}if(f({signer:r.iss,data:t[0]+"."+t[1],signature:d(t[2])}))return{issuer:r.iss,payload:r};throw new Error("JWT could not be verified")},e.verifySignature=f}));
//# sourceMappingURL=nacldid.umd.js.map
